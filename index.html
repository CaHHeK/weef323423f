<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Notifications</title>
    <style>
       .code {
            cursor: pointer;
            padding: 10px;
            margin: 5px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            display: inline-block;
            width: calc(50% - 20px);
            box-sizing: border-box;
            white-space: pre-wrap;
        }
        #codesContainer {
            display: flex;
            flex-wrap: wrap;
        }
        button {
            margin: 5px;
        }
    </style>
</head>
<body>
    <div id="codesContainer"></div>
    <textarea id="newCodesInput" placeholder="Введите новые коды, каждый с новой строки" rows="5" cols="30"></textarea>
    <br>
    <button onclick="addNewCodes()">Добавить коды</button>
    <button onclick="clearCodes()">Очистить коды</button>
    <button onclick="sendNotification()">Тест уведомления</button>
    <br>
    <button onclick="enableNotifications()">Включить уведомления</button>
    <button onclick="disableNotifications('1 час')">Выключить на 1 час</button>
    <button onclick="disableNotifications('6 часов')">Выключить на 6 часов</button>
    <button onclick="disableNotifications('всегда')">Выключить на всегда</button>

    <script>
        const storageKey = 'savedCodes';
        const notificationCountKey = 'notificationCount';
        const lastNotificationTimeKey = 'lastNotificationTime';
        let codes = [];
        let notificationInterval;

        // Регистрация Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/weef323423f/sw.js').then(reg => {
                console.log('Service Worker зарегистрирован:', reg);
            }).catch(err => {
                console.error('Ошибка регистрации Service Worker:', err);
            });
        }

        // Загрузка кодов из localStorage
        function loadCodes() {
            const savedCodes = localStorage.getItem(storageKey);
            if (savedCodes) {
                codes = JSON.parse(savedCodes);
            }
        }

        // Сохранение кодов в localStorage
        function saveCodes() {
            localStorage.setItem(storageKey, JSON.stringify(codes));
        }

        // Отображение кодов на странице
        function renderCodes() {
            const container = document.getElementById('codesContainer');
            container.innerHTML = '';
            codes.forEach((code, index) => {
                const codeDiv = document.createElement('div');
                codeDiv.className = 'code';
                codeDiv.innerText = code;
                codeDiv.onclick = () => handleCodeClick(code, index);
                container.appendChild(codeDiv);
            });
        }

        // Добавление новых кодов
        function addNewCodes() {
            const newCodes = document.getElementById('newCodesInput').value.split('\n');
            newCodes.forEach(code => {
                code = code.trim();
                if (code) {
                    codes.push(code);
                }
            });
            saveCodes();
            renderCodes();
            document.getElementById('newCodesInput').value = '';
        }

        // Очистка всех кодов
        function clearCodes() {
            codes = [];
            saveCodes();
            renderCodes();
        }

        // Обработка клика по коду
        function handleCodeClick(code, index) {
            copyToClipboard(code);
            codes.splice(index, 1);  // Удаление кода из массива
            saveCodes();  // Сохранение обновленного массива
            openTelegramBot();  // Открытие Telegram-бота
            window.close();  // Закрытие текущего окна
        }

        // Копирование текста в буфер обмена
        function copyToClipboard(text) {
            const tempInput = document.createElement("input");
            tempInput.style.position = "absolute";
            tempInput.style.left = "-9999px";
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
        }

        // Открытие Telegram-бота
        function openTelegramBot() {
            window.location.href = 'https://t.me/hamsTer_kombat_bot/start';
        }

        // Отправка тестового уведомления
        function sendNotification() {
            if (codes.length === 0) return;

            const lastNotificationTime = localStorage.getItem(lastNotificationTimeKey);
            const notificationCount = localStorage.getItem(notificationCountKey) || 0;

            // Проверка на количество уведомлений
            if (notificationCount >= 6) {
                const elapsedTime = Date.now() - lastNotificationTime;
                if (elapsedTime < 2 * 60 * 60 * 1000) { // Меньше 2 часов
                    console.log('Превышен лимит уведомлений.');
                    return;
                } else {
                    localStorage.setItem(notificationCountKey, 0); // Сбросить счетчик
                }
            }

            // Отправка уведомления
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.showNotification('Забери код', {
                        body: 'Нажмите, чтобы получить ваш код',
                        icon: 'https://cahhek.github.io/weef323423f/unnamed.jpg',
                        data: {
                            url: 'https://cahhek.github.io/weef323423f/'  // URL главной страницы
                        }
                    });
                });

                // Обновление времени и счетчика уведомлений
                localStorage.setItem(lastNotificationTimeKey, Date.now());
                localStorage.setItem(notificationCountKey, parseInt(notificationCount) + 1);
            }
        }

        // Включение уведомлений
        function enableNotifications() {
            if ("Notification" in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        scheduleNextNotification();
                    }
                });
            }
        }

        // Отключение уведомлений на заданное время
        function disableNotifications(duration) {
            clearInterval(notificationInterval);
            let timeout;

            switch (duration) {
                case '1 час':
                    timeout = 1 * 60 * 60 * 1000; // 1 час
                    break;
                case '6 часов':
                    timeout = 6 * 60 * 60 * 1000; // 6 часов
                    break;
                case 'всегда':
                    return; // Полное отключение без повторного включения
                default:
                    timeout = 0;
            }

            setTimeout(() => {
                enableNotifications();
            }, timeout);
        }

        // Установка случайного интервала для уведомлений
        function scheduleNextNotification() {
            const min = 15 * 1000; // 15 секунд
            const max = 30 * 1000; // 30 секунд
            const timeout = Math.floor(Math.random() * (max - min + 1)) + min;

            notificationInterval = setInterval(() => {
                sendNotification();
            }, timeout);
        }

        // Загрузка и отображение кодов при загрузке страницы
        loadCodes();
        renderCodes();
    </script>

</body>
</html>
